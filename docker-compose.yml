version: '3.7'

services:
  init:
    image: {% verbatim %}{{ CONTAINER_IMAGE }}{% endverbatim %}
    command: ./init.sh
    env_file:
      - ./.env

  app:
    image: {% verbatim %}{{ CONTAINER_IMAGE }}{% endverbatim %}
    restart: unless-stopped
    init: true
    expose:
      - 8000
    read_only: true
    volumes:
      - ./logfiles:/var/log/app
      - ./data:/data
    tmpfs:
      - /var/run/app
      - /app/cache
      - /tmp
    entrypoint: ./entrypoint.sh
    healthcheck:
      test: ["CMD", "test", "-f", "/var/run/app/gunicorn.pid"]
      interval: 10s
      timeout: 10s
      retries: 3
    env_file:
      - ./.env
    depends_on:
      init:
        condition: service_completed_successfully
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.{{ repository_name }}.entrypoints=websecure"
      - "traefik.http.routers.{{ repository_name }}.rule=Host(`{{ repository_name }}-staging.cloudybay.com.tw`)"
      - "traefik.http.routers.{{ repository_name }}.tls=true"
      - "traefik.http.services.{{ repository_name }}.loadbalancer.server.port=8000"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1024M
    networks:
      - staging

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.4.2
    restart: unless-stopped
    hostname: {{ repository_name }}_beat
    volumes:
      - ./filebeat.docker.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./logfiles:/var/log/app:ro
      - filebeat:/usr/share/filebeat/data

volumes:
  filebeat:

networks:
  staging:
    external: true
    name: traefik_net
